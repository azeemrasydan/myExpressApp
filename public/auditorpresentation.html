<!doctype html>
<html lang="en">

<head>
    <!--
    /   Multipurpose: Free Template by FreeHTML5.co
    /   Author: https://freehtml5.co
    /   Facebook: https://facebook.com/fh5co
    /   Twitter: https://twitter.com/fh5co
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Document title -->
    <title>PLUS 5S</title>
    <!-- Stylesheets & Fonts -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i%7CRajdhani:400,600,700"
        rel="stylesheet">
    <!-- Plugins Stylesheets -->
    <link rel="stylesheet" href="assets/css/loader/loaders.css">
    <link rel="stylesheet" href="assets/css/font-awesome/font-awesome.css">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/aos/aos.css">
    <link rel="stylesheet" href="assets/css/swiper/swiper.css">
    <link rel="stylesheet" href="assets/css/lightgallery.min.css">
    <!-- Template Stylesheet -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Responsive Stylesheet -->
    <link rel="stylesheet" href="assets/css/responsive.css">
</head>

<style>
    .card img {
        border: 1px solid #ddd;
        border-radius: 2mm;
        padding: 1mm;
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;

        object-fit: cover;
    }
</style>

<body>
    <!-- Loader Start -->
    <div class="css-loader">
        <div class="loader-inner line-scale d-flex align-items-center justify-content-center"></div>
    </div>
    <!-- Loader End -->
    <!-- Header Start -->
    <header class="position-absolute w-100">
        <div class="container">
            <div class="top-header d-none d-sm-flex justify-content-between align-items-center">
                <div class="contact">
                    <a href="tel:+60199869507" class="tel"><i class="fa fa-phone" aria-hidden="true"></i>PLUS 5S
                        Hotline</a>
                    <a href="mailto:azeem.rasydan@plus.com.my;syahirah.sam@plus.com.my"><i class="fa fa-envelope"
                            aria-hidden="true"></i>PLUS 5S Team</a>
                </div>
                <nav class="d-flex aic">

                    <ul class="nav social d-none d-md-flex">

                    </ul>
                </nav>
            </div>
            <nav class="navbar navbar-expand-md navbar-light">
                <a class="navbar-brand" href="index.html"><img src="assets/images/logo.png" alt="Multipurpose"></a>
                <div class="group d-flex align-items-center">
                    <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation"><span
                            class="navbar-toggler-icon"></span></button>
                    <a class="login-icon d-sm-none" href="#"><i class="fa fa-user"></i></a>

                </div>
                <a class="search-icon d-none d-md-block" href="#"><i class="fa fa-search"></i></a>
                <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="index.html">Laman Utama</a></li>
                        <li class="nav-item"><a class="nav-link"
                                href="https://pmbgrp.sharepoint.com/sites/QMCM/SitePages/SDCAC.aspx">Fungsi PKPK</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="garispanduan.html">Garis Panduan</a></li>
                        <li class="nav-item"><a class="nav-link"
                                href="https://apps.powerapps.com/play/45e5dec9-6887-437b-a2b4-3c3dd457703b?tenantId=4b4a4c51-ed99-465f-96cd-1a5bc81a8d60&hidenavbar=true"
                                target="_blank">PowerApps</a></li>
                        <li class="nav-item"><a class="nav-link" href="penemuanauditdalaman.html">Penemuan Audit</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="infoterkini.html">Info Terkini</a></li>

                    </ul>
                    <form class="bg-white search-form" method="get" id="searchform">
                        <div class="input-group">
                            <input class="field form-control" id="s" name="s" type="text" placeholder="Search">
                            <span class="input-group-btn">
                                <input class="submit btn btn-primary" id="searchsubmit" name="submit" type="submit"
                                    value="Search">
                            </span>
                        </div>
                    </form>
                </div>
            </nav>
        </div>
    </header>
    <!-- Header End -->
    <!-- Hero Start -->
    <section class="services">
        <div class="container" style="margin-top: 100px">
            <h1>PENEMUAN AUDIT 5S PLUS</h1>

            <div id="idprompt">
                <label for="fname" style="font-weight: bold;">Masukkan no kod ID:</label>
                <input type="text" id="fname" name="fname" style="text-align:center"><br><br>
                <button type="button" onclick="loadDoc()">Dapatkan Penemuan Audit 5S</button>
                <p id="demo"></p>
            </div>
        </div>
        <div id="summaryBox" style="padding: 5px 5px 5px 5px; color: black;font-weight:100"></div>
        <div id="maindisplay">
        </div>
    </section>





    <!-- Hero End -->
    <!-- Call To Action Start -->

    <!-- Call To Action End -->
    <!-- Services Start -->

    <!-- Services End -->
    <!-- Featured Start -->

    <!-- Featured End -->
    <!-- Recent Posts Start -->

    <!-- Recent Posts End -->
    <!-- Trust Start -->

    <!-- Trust End -->
    <!-- Pricing Start -->

    <!-- Pricing End -->
    <!-- Testimonial and Clients Start -->

    <!-- Testimonial and Clients End -->
    <!-- Call To Action 2 Start -->

    <!-- Call To Action 2 End -->
    <!-- Footer Start -->

    <!-- Widgets Start -->

    <!-- Widgets End -->
    <!-- Foot Note Start -->

    <!-- Foot Note End -->

    <!-- Footer Endt -->
    <!--jQuery-->
    <script src="assets/js/jquery-3.3.1.js"></script>
    <!--Plugins-->
    <script src="assets/js/bootstrap.bundle.js"></script>
    <script src="assets/js/loaders.css.js"></script>
    <script src="assets/js/aos.js"></script>
    <script src="assets/js/swiper.min.js"></script>
    <script src="assets/js/lightgallery-all.min.js"></script>
    <!--Template Script-->
    <script src="assets/js/main.js"></script>


    <script>

        var unixnamefilestring;
        var uniqueauditfilename;

        unixnamefilestring = Math.round(Math.floor(Date.now() / 1000) / 600) + 1;
        uniqueauditfilename = "https://prod-07.southeastasia.logic.azure.com:443/workflows/d43f5169bbcd47e791cd8c5da8d73a08/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_Rf367PRxdET1tw14GHRyo82o5lBLgXCO17x_Ne7ckw";
        uniquefasilitifilename = "https://prod-18.southeastasia.logic.azure.com:443/workflows/415a89ff009a404aa9a0d7f42da61225/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mIklpr3bdUd783c57Bc68P2pTG81QGzU9Z5MfFSULHI";
        uniquelocdetailfilename = "https://prod-13.southeastasia.logic.azure.com:443/workflows/94dad5065fd3461b9857b6c5bdc8c2e8/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ATcM8NLnGC_zUIXm-GtL6RhoxB89l-AxOtQ4AFoh_n8";
        uniquepremisedetailfilename = "https://prod-01.southeastasia.logic.azure.com:443/workflows/1863c38779124a0d8ecfdca9bb1245ee/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lD6gt0bL6NSdvA_C4SSkMT4FNTFzJN9H06DD6zvnIuM";
        unique50specificfilename = "https://prod-17.southeastasia.logic.azure.com:443/workflows/b34126764f754993b9cbea4cc2299390/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=oLyOfFVjGbDLhWwTgGUUwbkVRyE7kQFLYf6yYmSf-4w";
        uniquegambarpenemuanfilename = "https://prod-27.southeastasia.logic.azure.com:443/workflows/15e537089bca408a8a73464032881008/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qfsYlP-6wfLAiBBycyFg9DtpW31TD4Mz-8ZZkJYxhDA";


        //console.log(uniqueauditfilename);


        var alljsondata = [];
        var locationauditee;
        var id5s;

        function loadDoc() {
            document.getElementById("maindisplay").innerHTML = "<div class=\"d-flex justify-content-center\">\n<div class=\"spinner-border\" role=\"status\">\n<span class=\"sr-only\">Loading...</span>\n</div>\n</div>"
            document.getElementById("summaryBox").innerHTML = ""

            var xhttp = new XMLHttpRequest();
            var myObj;
            var auditeeID = document.getElementById("fname").value;
            locationauditee = auditeeID.split("-")[0];
            id5S = auditeeID.split("-")[1];
            alljsondata = [];

            // Request to get multiple files using XMLHTTP request

            var index = [uniqueauditfilename, uniquefasilitifilename, uniquelocdetailfilename, uniquepremisedetailfilename, unique50specificfilename, uniquegambarpenemuanfilename];

            var data;


            for (var i = 0; i < index.length; i++) {

                var url = index[i];

                let request = new XMLHttpRequest();
                request.open("POST", url);
                request.setRequestHeader("Content-Type", "application/json");
                request.onreadystatechange = function () {
                    if (request.readyState === XMLHttpRequest.DONE && request.status === 200) {
                        data = JSON.parse(request.responseText);

                        if (alljsondata.length < 6) {
                            alljsondata.push(data);

                            if (alljsondata.filter(Boolean).length == 6) {
                                jsonFunctionReturn(alljsondata);
                            }

                        }

                    }

                    if (request.status === 502 && (i == 1 || i == 2)) {
                        alert("System error, please try again");
                        document.getElementById("maindisplay").innerHTML;
                    }


                }
                if (i == 0 || i == 3 || i == 5) {
                    var dataaudit = JSON.stringify({ "try": document.getElementById("fname").value.split("-")[0] });
                    //console.log(dataaudit);
                    request.send(dataaudit);
                }
                else {
                    request.send();
                }
            }



        }


        var auditfilejson;
        var fasiliti5sjson;
        var locationdetailjson;
        var premisedetailjson;
        var specificdetailsjson;
        var shareablelinkjson;
        var EvidenceImageTrue;

        var locationIDprompt;
        var specareaIDprompt;
        var locat;

        var listfinding = "";
        var onetimecall = true;

        function jsonFunctionReturn(myObj) {
            listfinding = "";
            auditfilejson = {};
            var todisplayarray = [];
            // Assign each array from myObj retrieved from XMLHTTP request to the correct category of JSON
            myObj.forEach(function (elementsall) {

                try {
                    if (elementsall[0].ReferenceNo_x002e_ != undefined) { auditfilejson = elementsall; }
                    if (elementsall[0].BILIK_x0020_FASILITI != undefined) { fasiliti5sjson = elementsall; }
                    if (elementsall[0].Overall != undefined) { locationdetailjson = elementsall; }
                    if (elementsall[0].Lot_x0020_No_x002e_ != undefined) { premisedetailjson = elementsall; }
                    if (elementsall[0].Specific_x0020_Details != undefined) { specificdetailsjson = elementsall; }
                    if (elementsall[0].ShareAbleLink != undefined) { shareablelinkjson = elementsall; }
                }
                catch (err) {
                    alert("Sila masukkan no id yang sah");
                    document.getElementById("maindisplay").innerHTML = "";
                }
            });
            //console.log(specificdetailsjson);

            locationIDprompt = document.getElementById("fname").value.split("-")[0];
            specareaIDprompt = document.getElementById("fname").value.split("-")[1];
            //console.log(specareaIDprompt);




            //Filter finding according to ID prompt no
            todisplayarray = auditfilejson.filter(function (item) {

                locat = lookupProfile(locationdetailjson, "Abbreviation", locationIDprompt, "Location");

                if (item.Title == locat) {

                    return true;
                }


            });
            //console.log(todisplayarray);
            var inc;
            //console.log(todisplayarray.length);
            // To display HTML files from ID requested


            var tiadapenemuan;
            if (todisplayarray.length == 0) {

                tiadapenemuan = true;

            }

            todisplayarray = todisplayarray.filter(function (item) {

                if (item.Omitted_x003f_ != undefined) { return false; }

                if (item.CASubmission == undefined || item.CARejection == "Y") {
                    return true;
                } else { return false; }


            })

            var penemuandalamproses;
            if (todisplayarray.length == 0) {

                penemuandalamproses = true;

            } else {
                document.getElementById("maindisplay").innerHTML = "";
            }


            for (inc = 0; inc < todisplayarray.length; inc++) {

                retrievepremisedetail = [];
                //i += i + 1;
                //console.log(i);

                var checkwhethercontractor = fasiliti5sjson.filter(function (elements) {

                    return elements.OData__x0035_S_x0020_ID == todisplayarray[inc].Area5SID

                });

                if (checkwhethercontractor.length > 0) {
                    var areatitle = lookupProfile(fasiliti5sjson, "OData__x0035_S_x0020_ID", todisplayarray[inc].Area5SID, "Title");
                    var areaowner = "PLUS Bhd";
                    var premiseno = todisplayarray[inc].Area5SID

                } else {

                    var retrievepremisedetail = premisedetailjson.filter(function (elements) {
                        //console.log(elements.Location);

                        return elements.OData__x0035_S_x0020_ID == todisplayarray[inc].Area5SID && elements.Location == todisplayarray[inc].Title;

                    });
                    //console.log(retrievepremisedetail);
                    var areatitle = retrievepremisedetail[0].Location_x0020_Name;
                    var areaowner = retrievepremisedetail[0].Person_x0020_In_x0020_Charge;
                    var premiseno = retrievepremisedetail[0].OData__x0035_S_x0020_ID;

                    if (premiseno == undefined) {
                        premiseno = "-";
                    }
                }

                var refno = todisplayarray[inc].ReferenceNo_x002e_;

                var ftpfilelink = "https://5saudit.azurewebsites.net/assets/5SImage/" + refno + "[1].jpg";
                var ftpfilelinkbackup = "https://rjemuvfws8cu1il5q5n2zg-on.drv.tw/www.unit5splus.tk/indexfolder/image/5S%20Folder/" +  refno + "[1].jpg";
                var htmlImage = "<img id= \"" + refno + "[1].jpg" + "\" src=\"" + ftpfilelink + "\" onerror=\"this.onerror=null; this.src='" + ftpfilelinkbackup + "'\">";

                if (todisplayarray[inc].EvidenceLink2 != undefined) {

                    var ftpFileLink1 = "https://5saudit.azurewebsites.net/assets/5SImage/" + refno + "[2].jpg";
                    var ftpFileLink1Backup = "https://rjemuvfws8cu1il5q5n2zg-on.drv.tw/www.unit5splus.tk/indexfolder/image/5S%20Folder/" +  refno + "[2].jpg";

                    htmlImage = htmlImage + "<img id= \"" + refno + "[2].jpg" + "\" src=\"" + ftpFileLink1 + "\" onerror=\"this.onerror=null; this.src='" + ftpFileLink1Backup + "'\">";
                    var ftpFileLink2Backup = "https://rjemuvfws8cu1il5q5n2zg-on.drv.tw/www.unit5splus.tk/indexfolder/image/5S%20Folder/" +  refno + "[3].jpg";
                    var ftpFileLink2 = "https://5saudit.azurewebsites.net/assets/5SImage/" + refno + "[3].jpg";

                    if (todisplayarray[inc].EvidenceLink3 != 3) { htmlImage = htmlImage + "<img id= \"" + refno + "[3].jpg" + "\" src=\"" + ftpFileLink2 + "\" onerror=\"this.onerror=null; this.src='" + ftpFileLink2Backup + "'\">"; }

                }



                //imageExists(evidenceimage, function(exists) {console.log('RESULT: url=' + evidenceimage + ', exists=' + exists);});


                /*if(evidenceimage == undefined){
                    var evidenceimage = "https://thumbs.dreamstime.com/b/no-image-available-icon-flat-vector-no-image-available-icon-flat-vector-illustration-132482930.jpg"
                }*/

                var kategorikesalahan = todisplayarray[inc].Type_x0020_of_x0020_Finding.Value;
                var checkpoint50 = todisplayarray[inc].OData__x0035_0Checkpoint;
                var tajukkesalahan = todisplayarray[inc].FindingTitle;

                switch (kategorikesalahan) {
                    case "OB":
                        kategorikesalahan = "Observation / Penemuan";
                        break;
                    case "NC":
                        kategorikesalahan = "Non-Conformance / Ketidakpatuhan"
                        break;
                    case "BP":
                        kategorikesalahan = "Amalan Terbaik"
                        break;
                    default:
                        kategorikesalahan = "-"

                }


                if (todisplayarray[inc].FindingRemarks != undefined) {
                    var keterangankesalahan = todisplayarray[inc].FindingRemarks;
                } else { keterangankesalahan = "-" }

                //console.log(areatitle + " :" + refno + " - " + evidenceimage + " - " + kategorikesalahan + " - " + checkpoint50 + " - " + tajukkesalahan + " - " + keterangankesalahan);

                document.getElementById("maindisplay").innerHTML += " <div class=\"card\">\n<h2>" + areatitle + "</h2>\n<p>Dikendali oleh " + areaowner + "</p>\n<p>No Rujukan: " + refno + "</p>\n<p>ID Kawasan: " + premiseno + "</p>\n" + htmlImage + "\n<p><b>Klasifikasi penemuan audit: </b>" + kategorikesalahan + "</p>\n<p><b>Klausa 5S: </b>" + checkpoint50 + ": " + tajukkesalahan + "</p>\n<p><b>Keterangan</b></p>\n<p>" + keterangankesalahan + "</div>";
                //imageSharepointDirect(refno + "[1].jpg");




            };
            document.getElementById("summaryBox").innerHTML = "Jumlah Penemuan Belum Terima Maklum Balas: " + todisplayarray.length;
            //document.getElementById("maindisplay").innerHTML = listfinding;
            if (tiadapenemuan) {
                document.getElementById("maindisplay").innerHTML = "<h2 style =\"text-align: center\">Tahniah, tiada penemuan di tempat anda!</h2>"
            } else if (penemuandalamproses) {

                document.getElementById("maindisplay").innerHTML = "<h2 style =\"text-align: center\">Semua maklumbalas anda telah dihantar dan sedang di dalam proses!</h2>"
            }

            console.log(listfinding);

        }


        function lookupProfile(myObj, propertytolookup, valtolookup, lookedupprop) {

            for (var i = 0; i < myObj.length; i++) {

                if (myObj[i][propertytolookup] === valtolookup) {
                    if (myObj[i].hasOwnProperty(lookedupprop) === true) {
                        return myObj[i][lookedupprop];
                    }

                    else {
                        return undefined;
                    }

                }

            }
        }



        function imageSharepointDirect(fileName) {

            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var graphql = JSON.stringify({
                query: "",
                variables: { "fileName": fileName }
            })
            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: graphql,
                redirect: 'follow'
            };

            fetch("https://prod-16.southeastasia.logic.azure.com:443/workflows/d69b8670ce614f0c9ca9f5a054305253/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=X0lnfzAB69VJhJGX6eU0HbVFglE8mj_nunzK7B70bxQ", requestOptions)
                .then(response => {
                    // response.blob().then(blobResponse => {
                    //     data = blobResponse;
                    //     console.log(data);
                    //     const imageFileName = document.getElementById(fileName);
                    //     //console.log(outside);
                    //     const urlCreator = window.URL || window.webkitURL;
                    //     imageFileName.src = urlCreator.createObjectURL(data);
                    // });

                    console.log(btoa(response.text()));
                })
                .then(data => {

                    console.log(data);

                })
                .catch(error => console.log('error', error));
        }


    </script>



</body>

</html>